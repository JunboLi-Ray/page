tcp

tcp选项

tcpnodelay，有包直接发送，不整合一起。
tcpnopush，一般传文件，将包整合到一起发送。
tcpquickack，开启，对请求的ack和返回内容分开传。


1、可靠
停止等待协议：发送完等待确认再发送，超时就再发送。
停止等待利用率太低，就用流水线传输，一次传输多个。但需要滑动窗口协议配合来一次发送多个数据。

滑动窗口：字节为单位。3个指针在发送缓存内，开始、已发送（未收到确认）、结束指针。

发送超时时间：
当次预估往返时间=7/8旧的往返时间+1/8新的时间样本
超时时间=当次预估往返时间+4*（3/4*旧的括号内值，第一次为时间样本的一半+1/4|当次预估往返时间-时间样本|）
由于确认报文在发生重传时，导致计算不准，则重传就2倍超时时间，不发生重传时再计算。

2、流控
nagle：先发一个字节，发送完这个报文后，等待确认了，再发在这期间缓存起来的字节，提升传输效率。
糊涂窗口：接收方等待一会，多处理些，这样接收方缓存空闲就大了，再给发送方确认，这样窗口就大了，免的每次窗口都是1，浪费传输效率。

3、拥塞控制
解决网络拥堵，不是流控为了机器来得及接受。

慢开始：开始发送1个，然后翻倍，若超时即网络阻塞，又从1开始。
拥塞避免：达到上次网络拥塞发送的字节数一半时，即门限值，开始执行，每次不翻，自增1。

快重传：若接收方收到新的字节不挨着上一条，那就不等着统一发送，而是每收到新的信息都发送对丢失的确认。发送方收到3条一样的报文确认，不等丢失报文超时就马上再发次丢失报文。（快速知道包丢了）
快恢复：收到3个确认了，一个没收到或收到慢，则将门线减半，同时窗口设为减半得值，开始拥塞避免算法。

4、综上，实际窗口取流控和拥塞控制较小的数

5、连接
建立：
3次握手，避免网络问题发送两次建立请求，就真的两个链接了。
syn 1              seq x
syn 1 ack 1    ack x+1 seq y
ack 1              ack y+1 seq x+1

释放：
4次握手，关闭两个方向的连接。一方发起，另一方可以在第2次后发送待发数据或没有不发，然后发起关闭请求。发起方第4次收到确认后，要多等几分钟，防再建连接，有之前的报文收到。
fin 1             seq x
ack 1           ack x+1 seq y
…
fin 1 ack 1   seq y ack x+1
ack 1           seq x+1 ack y+1

长时间没收到报文，就发送探测报文，若多个探测都没响应就关闭。

6、状态机
粗实线 客户端进程
粗虚线 服务器进程
细线 异常
￼
<img>

7、报文格式


源端口16，目的端口16
已发送序列号，序列号
希望接收序列号，确认号
偏移数据在报文的位置，标示头大小4，保留6，urg，psh，ack，syn，fin，rst6，窗口大小16
校验和16，紧急指针16
选项n，补位n
数据……


偏移，4位，最大15行，60字节
ack 连接建立后，一直1
urg 放到发送连接头立即发送
psh 收到后，直接给上层，不等满
紧急指针说这个报文紧急到哪儿结束
选项现在有：
最大报文段长度MSS，报文的最大长度，不写默认536+20头，尽量控制IP不分片。
窗口扩大选项，网快了，窗口太小。
时间戳，计算rtt，防止网快序号回到0不认识。
sack选择确认，只收中间缺失的，后面收到的可以不用传了。