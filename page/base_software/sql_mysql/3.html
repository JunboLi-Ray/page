三 锁
锁分为lock，锁表，锁行
latch资源，对象，线程

自增长锁，完成自增长值插入sql后释放锁，不等事务结束。
对于知道插入行数的，可以进行累加。

s锁，读锁，分享型
x锁，写锁，更改型
x锁申请要等s锁执行完毕

record lock 单个行的锁
gap lock 间隙锁 锁一个范围
next key lock 锁范围并锁定记录（解决了幻读问题，注意不是mvcc解决）

间隙锁：防止不存在数据区间在执行期间，被改变。insert不存在值也要锁，有可能其他处在范围操作。

锁三个问题
脏读，读到未提交事务，不可接受
不可重复读，因读到提交事务，结果不一致，可接受
丢失更新，两个事务一起更新，只看到一个，该串行


通过等待图，来观察是否有死锁。
位图最小单位是页，所以不管页中几个记录，锁住开销一样。


加锁原则

拿MySql的InnoDB引擎来说，对于insert、update、delete等操作。会自动给涉及的数据加排他锁；

对于一般的select语句，InnoDB不会加任何锁，事务可以通过以下语句给显示加共享锁或排他锁。
共享锁：SELECT ... LOCK IN SHARE MODE;
排他锁：SELECT ... FOR UPDATE;